name: ğŸš€ Deploy Dokter Stats API Fix to Hostinger

on:
  workflow_dispatch:
    inputs:
      test_endpoint:
        description: 'Test API endpoint after deployment'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      clear_caches:
        description: 'Clear Laravel caches after deployment'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  deploy-dokter-stats-fix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy Dokter Stats API Fix
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "app/Http/Controllers/Api/DokterStatsController.php,routes/api.php"
          target: "/tmp/dokter-fix/"
          strip_components: 0

      - name: ğŸ”§ Install Dokter Stats Fix
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          timeout: 300s
          script: |
            set -e
            echo "ğŸš€ Installing Dokter Stats API Fix"
            echo "=================================="
            echo "ğŸ“… Started at: $(date)"
            
            cd domains/dokterkuklinic.com/public_html
            
            # Create backup of existing files
            echo "ğŸ’¾ Creating backup..."
            mkdir -p ~/backups/dokter-fix/$(date +%Y%m%d_%H%M%S)
            BACKUP_DIR="~/backups/dokter-fix/$(date +%Y%m%d_%H%M%S)"
            
            # Backup existing files if they exist
            [ -f "routes/api.php" ] && cp routes/api.php "$BACKUP_DIR/api.php.backup" || echo "No existing api.php to backup"
            [ -f "app/Http/Controllers/Api/DokterStatsController.php" ] && cp app/Http/Controllers/Api/DokterStatsController.php "$BACKUP_DIR/DokterStatsController.php.backup" || echo "No existing DokterStatsController.php to backup"
            
            # Create necessary directories
            echo "ğŸ“‚ Creating directories..."
            mkdir -p app/Http/Controllers/Api
            
            # Install new files
            echo "ğŸ“¦ Installing new files..."
            cp /tmp/dokter-fix/app/Http/Controllers/Api/DokterStatsController.php app/Http/Controllers/Api/DokterStatsController.php
            cp /tmp/dokter-fix/routes/api.php routes/api.php
            
            # Set proper permissions
            echo "ğŸ” Setting permissions..."
            chmod 644 app/Http/Controllers/Api/DokterStatsController.php
            chmod 644 routes/api.php
            
            # Clean up temp files
            rm -rf /tmp/dokter-fix
            
            echo "âœ… Files installed successfully"

      - name: ğŸ§¹ Clear Laravel Caches
        if: github.event.inputs.clear_caches == 'true'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd domains/dokterkuklinic.com/public_html
            
            echo "ğŸ§¹ Clearing Laravel caches..."
            php artisan config:clear || echo "Config clear skipped"
            php artisan route:clear || echo "Route clear skipped"
            php artisan view:clear || echo "View clear skipped"
            php artisan cache:clear || echo "Cache clear skipped"
            
            echo "ğŸ¨ Rebuilding caches..."
            php artisan config:cache || echo "Config cache skipped"
            php artisan route:cache || echo "Route cache skipped"
            
            echo "âœ… Cache operations completed"

      - name: ğŸ§ª Test Dokter Stats API Endpoints
        if: github.event.inputs.test_endpoint == 'true'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "ğŸ§ª Testing Dokter Stats API Endpoints"
            echo "===================================="
            
            # Test public endpoint (no auth required)
            echo "ğŸ“Š Testing public stats endpoint..."
            response=$(curl -s -o /dev/null -w "%{http_code}" https://dokterkuklinic.com/api/public/dokter/stats || echo "000")
            echo "   /api/public/dokter/stats â†’ HTTP $response"
            
            if [ "$response" = "200" ]; then
                echo "âœ… Public endpoint working!"
                
                # Test actual response content
                echo "ğŸ“‹ Sample response:"
                curl -s https://dokterkuklinic.com/api/public/dokter/stats | head -c 200
                echo ""
            else
                echo "âŒ Public endpoint failed with HTTP $response"
            fi
            
            # Test other potential endpoints
            echo ""
            echo "ğŸ“Š Testing other endpoints..."
            
            response2=$(curl -s -o /dev/null -w "%{http_code}" https://dokterkuklinic.com/api/dokter/stats || echo "000")
            echo "   /api/dokter/stats â†’ HTTP $response2"
            
            response3=$(curl -s -o /dev/null -w "%{http_code}" https://dokterkuklinic.com/api/api/dokter/stats || echo "000")
            echo "   /api/api/dokter/stats â†’ HTTP $response3"

      - name: ğŸ“Š Verify Laravel Routes
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd domains/dokterkuklinic.com/public_html
            
            echo "ğŸ“‹ Verifying Laravel routes..."
            php artisan route:list | grep -i dokter | head -5 || echo "No dokter routes found in route:list"
            
            echo ""
            echo "ğŸ” Checking if DokterStatsController exists..."
            if [ -f "app/Http/Controllers/Api/DokterStatsController.php" ]; then
                echo "âœ… DokterStatsController.php exists"
                echo "   File size: $(stat -f%z app/Http/Controllers/Api/DokterStatsController.php 2>/dev/null || stat -c%s app/Http/Controllers/Api/DokterStatsController.php) bytes"
            else
                echo "âŒ DokterStatsController.php missing"
            fi

      - name: ğŸ“‹ Deployment Summary
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo ""
            echo "ğŸ“Š DOKTER STATS API FIX DEPLOYMENT SUMMARY"
            echo "=========================================="
            echo "ğŸ¯ Objective: Fix 500 error on dokter dashboard stats"
            echo "ğŸ“… Deployed: $(date)"
            echo "ğŸ”§ Components:"
            echo "   - DokterStatsController.php (New API controller)"
            echo "   - Updated routes/api.php with new endpoints"
            echo ""
            echo "ğŸ“‹ Available Endpoints:"
            echo "   - GET /api/public/dokter/stats (No auth)"
            echo "   - GET /api/dokter/stats (Auth required)"  
            echo "   - GET /api/api/dokter/stats (Auth required)"
            echo ""
            echo "ğŸ§ª Test URL:"
            echo "   https://dokterkuklinic.com/api/public/dokter/stats"
            echo ""
            echo "ğŸ¯ Expected Result:"
            echo "   - No more 500 errors"
            echo "   - Stats object with proper data structure"
            echo "   - attendance_rate_raw and performance_data defined"
            echo ""
            echo "âœ… Deployment Status: ${{ job.status }}"
            echo "ğŸ¤– Generated with [Claude Code](https://claude.ai/code)"