name: Sync Dashboard to Production

on:
  push:
    branches:
      - main
    paths:
      # Dashboard Views
      - 'resources/views/dashboard.blade.php'
      - 'resources/views/*/dashboard.blade.php'
      - 'resources/views/paramedis/dashboards/**'
      - 'resources/views/filament/**/dashboard*.blade.php'
      - 'resources/views/filament/**/pages/**dashboard*.blade.php'
      
      # Dashboard Controllers
      - 'app/Http/Controllers/DashboardController.php'
      - 'app/Http/Controllers/*/DashboardController.php'
      - 'app/Http/Controllers/*/*DashboardController.php'
      - 'app/Http/Controllers/Api/V2/Dashboards/**'
      
      # Filament Dashboard Pages
      - 'app/Filament/**/Dashboard*.php'
      - 'app/Filament/**/Pages/*Dashboard*.php'
      
      # React Dashboard Components
      - 'resources/react/**dashboard**/**'
      
      # Dashboard CSS
      - 'resources/css/*dashboard*.css'
      - 'public/css/*dashboard*.css'
      
      # Dashboard Routes
      - 'routes/web.php'
      - 'routes/api.php'
      
      # Dashboard Assets
      - 'public/build/**'
      - 'public/js/**'
      - 'public/css/**'
      
  workflow_dispatch:
    inputs:
      sync_all:
        description: 'Sync all dashboard files regardless of changes'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  PHP_VERSION: "8.3"
  NODE_VERSION: "20"

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      dashboard_changed: ${{ steps.filter.outputs.dashboard }}
      files_changed: ${{ steps.changed-files.outputs.files }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get changed files
        id: changed-files
        run: |
          if [ "${{ github.event.inputs.sync_all }}" = "true" ]; then
            echo "üîÑ Manual sync requested - syncing all dashboard files"
            echo "files=all" >> $GITHUB_OUTPUT
          else
            echo "üìã Detecting changed files..."
            FILES=$(git diff --name-only HEAD^ HEAD | grep -E "(dashboard|Dashboard)" || true)
            if [ -z "$FILES" ]; then
              echo "files=none" >> $GITHUB_OUTPUT
              echo "‚ÑπÔ∏è No dashboard files changed"
            else
              echo "files<<EOF" >> $GITHUB_OUTPUT
              echo "$FILES" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
              echo "‚úÖ Dashboard files changed:"
              echo "$FILES"
            fi
          fi

      - name: Check dashboard changes
        id: filter
        run: |
          if [ "${{ steps.changed-files.outputs.files }}" != "none" ]; then
            echo "dashboard=true" >> $GITHUB_OUTPUT
          else
            echo "dashboard=false" >> $GITHUB_OUTPUT
          fi

  sync-dashboard:
    needs: detect-changes
    if: needs.detect-changes.outputs.dashboard_changed == 'true' || github.event.inputs.sync_all == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv
          coverage: none

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install NPM dependencies
        run: npm ci

      - name: Build assets
        run: |
          echo "üî® Building frontend assets..."
          npm run build
          echo "‚úÖ Assets built successfully"

      - name: Prepare files for sync
        run: |
          echo "üì¶ Preparing dashboard files for sync..."
          
          # Create sync directory
          mkdir -p sync-files
          
          # Copy dashboard-related files
          echo "üìÑ Copying dashboard views..."
          mkdir -p sync-files/resources/views
          find resources/views -name "*dashboard*.blade.php" -exec cp --parents {} sync-files/ \; 2>/dev/null || true
          
          echo "üìÑ Copying Filament dashboard files..."
          mkdir -p sync-files/app/Filament
          find app/Filament -name "*Dashboard*.php" -exec cp --parents {} sync-files/ \; 2>/dev/null || true
          
          echo "üìÑ Copying dashboard controllers..."
          mkdir -p sync-files/app/Http/Controllers
          find app/Http/Controllers -name "*Dashboard*.php" -exec cp --parents {} sync-files/ \; 2>/dev/null || true
          
          echo "üìÑ Copying React dashboard components..."
          if [ -d "resources/react" ]; then
            mkdir -p sync-files/resources/react
            find resources/react -path "*dashboard*" -exec cp --parents {} sync-files/ \; 2>/dev/null || true
          fi
          
          echo "üìÑ Copying built assets..."
          mkdir -p sync-files/public
          cp -r public/build sync-files/public/ 2>/dev/null || true
          cp -r public/css sync-files/public/ 2>/dev/null || true
          cp -r public/js sync-files/public/ 2>/dev/null || true
          
          echo "üìã Files prepared for sync:"
          find sync-files -type f | head -20
          echo "..."
          echo "Total files: $(find sync-files -type f | wc -l)"

      - name: Deploy Dashboard Files to Hostinger
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          timeout: 300s
          command_timeout: 60s
          script: |
            set +e
            echo "üöÄ Starting dashboard sync to Hostinger..."
            echo "üìÖ Sync started at: $(date)"
            
            cd domains/dokterkuklinik.com/public_html/dokterku
            
            # Create backup of current dashboard files
            echo "üíæ Creating backup of current dashboard files..."
            BACKUP_DIR="~/backups/dashboard/backup_$(date +%Y%m%d_%H%M%S)"
            mkdir -p "$BACKUP_DIR"
            
            # Backup dashboard views
            find resources/views -name "*dashboard*.blade.php" -exec cp --parents {} "$BACKUP_DIR/" \; 2>/dev/null || true
            
            # Backup Filament files
            find app/Filament -name "*Dashboard*.php" -exec cp --parents {} "$BACKUP_DIR/" \; 2>/dev/null || true
            
            echo "‚úÖ Backup created at: $BACKUP_DIR"
            
            echo "üîß Clearing Laravel caches (view/route only for dashboard sync)..."
            php artisan view:clear || echo "‚ö†Ô∏è View clear skipped"
            php artisan route:clear || echo "‚ö†Ô∏è Route clear skipped"
            
            echo "‚úÖ Dashboard sync preparation completed"

      - name: Copy Dashboard Files
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "sync-files/*"
          target: "domains/dokterkuklinik.com/public_html/dokterku/"
          strip_components: 1
          rm: false

      - name: Post-sync Operations
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set +e
            echo "üîß Running post-sync operations..."
            
            cd domains/dokterkuklinik.com/public_html/dokterku
            
            # Set proper permissions
            echo "üîê Setting file permissions..."
            find resources/views -name "*.blade.php" -exec chmod 644 {} \; 2>/dev/null || true
            find app -name "*.php" -exec chmod 644 {} \; 2>/dev/null || true
            chmod -R 755 public/build public/css public/js 2>/dev/null || true
            
            # Clear and rebuild caches (dashboard-specific, avoid database dependency)
            echo "üé® Optimizing dashboard caches..."
            php artisan view:cache || echo "‚ö†Ô∏è View cache skipped (may need database)"
            php artisan route:cache || echo "‚ö†Ô∏è Route cache skipped (may need database)"
            
            # Skip config cache as it may require database connection
            echo "‚ÑπÔ∏è Skipping config cache to avoid database dependency"
            
            # Optional: Run Filament commands (skip if requires database)
            echo "üîß Filament optimization..."
            php artisan filament:cache-components || echo "‚ö†Ô∏è Filament cache skipped"
            
            echo "‚úÖ Dashboard sync completed successfully!"
            echo "üåê Application URL: https://dokterkuklinik.com"
            
            # List synced dashboard files
            echo ""
            echo "üìã Recently synced dashboard files:"
            find resources/views -name "*dashboard*.blade.php" -mmin -5 2>/dev/null | head -10 || echo "No recent dashboard view changes"
            
            # Create sync completion marker
            echo "$(date): Dashboard sync completed" > storage/logs/dashboard-sync.log 2>/dev/null || true
            
            exit 0

      - name: Verify Dashboard Access
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "üîç Verifying dashboard file sync..."
            
            cd domains/dokterkuklinik.com/public_html/dokterku
            
            # Check if dashboard files exist
            echo "üìÅ Checking dashboard files..."
            if [ -f "resources/views/dashboard.blade.php" ]; then
              echo "‚úÖ Main dashboard view exists"
            else
              echo "‚ö†Ô∏è Main dashboard view missing"
            fi
            
            # Count dashboard files
            dashboard_views=$(find resources/views -name "*dashboard*.blade.php" 2>/dev/null | wc -l)
            dashboard_controllers=$(find app/Http/Controllers -name "*Dashboard*.php" 2>/dev/null | wc -l)
            filament_dashboards=$(find app/Filament -name "*Dashboard*.php" 2>/dev/null | wc -l)
            
            echo "üìä Dashboard files summary:"
            echo "   - Dashboard views: $dashboard_views"
            echo "   - Dashboard controllers: $dashboard_controllers" 
            echo "   - Filament dashboards: $filament_dashboards"
            
            # Check sync log
            if [ -f "storage/logs/dashboard-sync.log" ]; then
              echo ""
              echo "üìã Last sync:"
              tail -1 storage/logs/dashboard-sync.log
            fi
            
            # Basic HTTP test (without database dependency)
            echo ""
            echo "üåê Testing HTTP accessibility..."
            response=$(curl -s -o /dev/null -w "%{http_code}" https://dokterkuklinik.com || echo "000")
            if [ "$response" = "200" ] || [ "$response" = "302" ] || [ "$response" = "500" ]; then
                echo "‚úÖ Application responding (HTTP $response)"
                if [ "$response" = "500" ]; then
                  echo "‚ÑπÔ∏è HTTP 500 likely due to database connection (expected)"
                fi
            else
                echo "‚ö†Ô∏è Application not responding (HTTP $response)"
            fi

      - name: Notify sync status
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "üìä Dashboard Sync Summary"
            echo "======================="
            echo "Repository: ${{ github.repository }}"
            echo "Commit: ${{ github.sha }}"
            echo "Author: ${{ github.actor }}"
            echo "Status: ${{ job.status }}"
            echo "Sync Type: ${{ github.event.inputs.sync_all == 'true' && 'Manual Full Sync' || 'Auto Change Sync' }}"
            echo "Date: $(date)"
            echo ""
            
            if [ "${{ needs.detect-changes.outputs.files_changed }}" != "all" ] && [ "${{ needs.detect-changes.outputs.files_changed }}" != "none" ]; then
              echo "üìÑ Changed files:"
              echo "${{ needs.detect-changes.outputs.files_changed }}"
            fi
            
            echo ""
            echo "ü§ñ Generated with [Claude Code](https://claude.ai/code)"
            echo "üöÄ Automated dashboard sync by Claude AI Assistant"