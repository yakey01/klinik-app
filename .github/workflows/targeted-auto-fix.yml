name: ğŸ¯ Targeted Auto-Fix

on:
  workflow_dispatch:
    inputs:
      test_name:
        description: 'Specific test to fix (optional)'
        required: false
        default: ''
        type: string

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  targeted-fix:
    name: ğŸ¯ Fix Specific Issues
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv
          tools: composer:v2

      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist

      - name: Quick targeted fixes
        id: quick-fix
        run: |
          echo "ğŸ¯ Applying targeted fixes for known issues..."
          
          # Fix PetugasStatsService date query issue
          if [ -f "app/Services/PetugasStatsService.php" ]; then
            echo "ğŸ”§ Fixing PetugasStatsService date queries..."
            
            # Backup original
            cp app/Services/PetugasStatsService.php app/Services/PetugasStatsService.php.backup
            
            # Apply specific fixes
            sed -i "s/->where('tanggal_input', \\\$date->format('Y-m-d'))/->whereDate('tanggal_input', \\\$date->format('Y-m-d'))/g" app/Services/PetugasStatsService.php
            sed -i "s/->where('tanggal', \\\$date->format('Y-m-d'))/->whereDate('tanggal', \\\$date->format('Y-m-d'))/g" app/Services/PetugasStatsService.php
            sed -i "s/status_validasi = 'approved'/status_validasi = 'disetujui'/g" app/Services/PetugasStatsService.php
            sed -i "s/DATE(approved_at)/DATE(validated_at)/g" app/Services/PetugasStatsService.php
            
            echo "âœ… PetugasStatsService fixes applied"
          fi
          
          # Fix test file if exists
          if [ -f "tests/Unit/Services/PetugasStatsServiceTest.php" ]; then
            echo "ğŸ§ª Fixing test assertions..."
            
            # Backup original
            cp tests/Unit/Services/PetugasStatsServiceTest.php tests/Unit/Services/PetugasStatsServiceTest.php.backup
            
            # Fix test expectations
            sed -i "s/'status_validasi' => 'approved'/'status_validasi' => 'disetujui'/g" tests/Unit/Services/PetugasStatsServiceTest.php
            sed -i "s/'approved_at'/'validated_at'/g" tests/Unit/Services/PetugasStatsServiceTest.php
            
            echo "âœ… Test fixes applied"
          fi
          
          # Check if any changes were made
          if ! git diff --quiet; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ Changes detected:"
            git diff --name-only
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "ğŸ“ No changes were needed"
          fi

      - name: Run tests to verify fixes
        if: steps.quick-fix.outputs.has_changes == 'true'
        run: |
          echo "ğŸ§ª Testing fixes..."
          
          # Run specific test if provided
          if [ -n "${{ github.event.inputs.test_name }}" ]; then
            echo "Running specific test: ${{ github.event.inputs.test_name }}"
            php artisan test --filter="${{ github.event.inputs.test_name }}"
          else
            echo "Running PetugasStatsService tests..."
            php artisan test tests/Unit/Services/PetugasStatsServiceTest.php
          fi
          
          # Check overall test status
          if php artisan test --stop-on-failure; then
            echo "âœ… All tests are now passing!"
            echo "test_success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Some tests still failing, but fixes were applied"
            echo "test_success=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Create simple PR
        if: steps.quick-fix.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ğŸ¯ Fix PetugasStatsService date query and validation issues
            
            Applied targeted fixes for:
            - Changed where() to whereDate() for date comparisons
            - Fixed validation status from 'approved' to 'disetujui'
            - Updated column name from 'approved_at' to 'validated_at'
            - Fixed test assertions to match expected values
            
            ğŸ§ª Test Status: ${{ steps.quick-fix.outputs.test_success == 'true' && 'âœ… Tests passing' || 'âŒ Need review' }}
          branch: fix-petugas-stats-${{ github.run_id }}
          title: "ğŸ¯ Fix PetugasStatsService pendapatan_sum issue"
          body: |
            ## ğŸ¯ Targeted Fix for PetugasStatsService
            
            This PR fixes the specific issue where `pendapatan_sum` was returning 0.0 instead of expected value.
            
            ### ğŸ”§ Changes Made:
            
            1. **Date Query Fix**: Changed `where()` to `whereDate()` for proper date comparisons
            2. **Validation Status**: Fixed 'approved' â†’ 'disetujui' mapping
            3. **Column Names**: Updated 'approved_at' â†’ 'validated_at'
            4. **Test Assertions**: Fixed test expectations to match corrected logic
            
            ### ğŸ§ª Test Results:
            - **Status**: ${{ steps.quick-fix.outputs.test_success == 'true' && 'âœ… Tests passing' || 'âŒ Need review' }}
            
            ### ğŸ“‹ Files Changed:
            - `app/Services/PetugasStatsService.php`
            - `tests/Unit/Services/PetugasStatsServiceTest.php`
            
            This is a **conservative, targeted fix** for the specific issue identified.
          labels: |
            ğŸ¯ targeted-fix
            ğŸ©º dokter-tindakan
            ğŸ§ª test-fix
          delete-branch: true

      - name: Summary
        if: always()
        run: |
          echo "ğŸ¯ Targeted Auto-Fix Summary"
          echo "=========================="
          echo "Changes made: ${{ steps.quick-fix.outputs.has_changes }}"
          echo "Tests passing: ${{ steps.quick-fix.outputs.test_success }}"
          echo ""
          echo "This workflow applies specific, targeted fixes for known issues."
          echo "It's more conservative than the full Smart Auto-Fix system."