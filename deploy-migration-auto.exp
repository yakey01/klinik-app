#!/usr/bin/expect -f

# Automated Expect Script for Pegawai Migration Deployment
# This script will automatically handle SSH password and run deployment

set timeout 30
set host "srv556.hstgr.io"
set user "u196138154"
set path "/home/u196138154/domains/dokterkuklinik.com/public_html"

# Prompt for password
send_user "ğŸ” Enter SSH password for $user@$host: "
stty -echo
expect_user -re "(.*)\n"
set password $expect_out(1,string)
stty echo
send_user "\n"

send_user "ğŸš€ Starting automated deployment...\n"

# Function to execute command and wait for prompt
proc ssh_command {cmd} {
    global password user host
    send "$cmd\r"
    expect {
        "password:" {
            send "$password\r"
            exp_continue
        }
        "$ " { return }
        "# " { return }
        timeout {
            send_user "âŒ Command timeout: $cmd\n"
            return
        }
    }
}

send_user "ğŸ“‹ STEP 1: Testing SSH connection\n"
spawn ssh -o StrictHostKeyChecking=no $user@$host
expect {
    "password:" {
        send "$password\r"
        expect "$ "
        send_user "âœ… SSH connection established\n"
    }
    timeout {
        send_user "âŒ SSH connection failed\n"
        exit 1
    }
}

send_user "ğŸ“‹ STEP 2: Navigating to application directory\n"
ssh_command "cd $path"

send_user "ğŸ“‹ STEP 3: Creating backup\n"
ssh_command "cp -r database/migrations database/migrations_backup_\$(date +%Y%m%d_%H%M%S) 2>/dev/null || echo 'No backup needed'"

send_user "ğŸ“‹ STEP 4: Pulling latest code\n"
ssh_command "git stash 2>/dev/null || true"
ssh_command "git pull origin main"

send_user "ğŸ“‹ STEP 5: Checking migration file\n"
ssh_command "ls -la database/migrations/2025_07_21_092713_add_email_column_to_pegawais_table.php"

send_user "ğŸ“‹ STEP 6: Clearing caches\n"
ssh_command "php artisan config:clear"
ssh_command "php artisan cache:clear"
ssh_command "php artisan route:clear"

send_user "ğŸ“‹ STEP 7: Running migrations\n"
ssh_command "php artisan migrate --force"

send_user "ğŸ“‹ STEP 8: Testing pegawai functionality\n"
ssh_command "php artisan tinker --execute=\"\\\$pegawai = new \\\\App\\\\Models\\\\Pegawai(); \\\$pegawai->nama_lengkap = 'Test'; \\\$pegawai->nik = '999'; \\\$pegawai->email = 'test@test.com'; \\\$pegawai->tanggal_lahir = '1990-01-01'; \\\$pegawai->jenis_kelamin = 'Laki-laki'; \\\$pegawai->jabatan = 'Test'; \\\$pegawai->jenis_pegawai = 'Paramedis'; \\\$pegawai->aktif = true; \\\$pegawai->input_by = 1; \\\$pegawai->save(); echo 'SUCCESS: Pegawai created'; \\\$pegawai->delete();\""

send_user "ğŸ“‹ STEP 9: Final optimization\n"
ssh_command "php artisan optimize:clear"
ssh_command "php artisan config:cache"

send_user "ğŸ‰ DEPLOYMENT COMPLETED!\n"
send_user "ğŸ“ Test at: https://dokterkuklinik.com/admin/pegawais/1/edit\n"

send "exit\r"
expect eof